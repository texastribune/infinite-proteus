/* infiniteproteus - v0.1.0 - 2013-09-26 */
!function(a,b){"use strict";var c="btn-primary",d="finiteEruptions",e={textareas:"textarea",remember:!0,template:'<div class="btn-group">  <button class="btn btn-mini prefs-selector" type=button>{{label}}</button></div>',getUI:function(a){return a.closest(".control-group").find("."+d)},placeUI:function(a,b){a.prependTo(b.closest(".control-group"))},_templates:{}};b.getScripts=function(a,c){var d=function(a,c){b.when(b.ajax({url:a.shift(),dataType:"script",cache:!0})).then(function(){a.length?d(a,c):c()})};d(a,c)};var f=function(){this.NONE="none",this.storage=window.localStorage,this.storageKey=d,this.data=void 0,this.load()};f.prototype.load=function(){var a={},b=this.storage.getItem(this.storageKey);this.data=b?JSON.parse(b):a},f.prototype.save=function(){this.storage.setItem(this.storageKey,JSON.stringify(this.data))},f.prototype.attachTo=function(a,e){var f=this,g=e.attr("id");g=window.location.pathname+"#"+g,a.on("click."+d,".prefs-selector",function(){var a=b(this),e=a.data(d).name,h=a.hasClass(c);f.data[g]=h?e:f.NONE,f.save()})},f.prototype.clear=function(){this.storage.removeItem(this.storageKey)},f.prototype.get=function(a){return a=window.location.pathname+"#"+a,this.data[a]};var g,h,i,j=[],k=function(a,c){var e=h.getUI(c);e.length||(e=b(h._templates.container).addClass(d),h.placeUI(e,c),h.remember&&i.attachTo(e,c)),a.appendTo(e)},l=function(a){j.push(a)},m=function(a){return a.isInstalled?!a.isInstalled():a.css&&a.css.length?!b("link[href*='"+a.css[0]+"']").length:!0},n=function(a){return function(){a.init&&a.init(),g.each(function(e,f){var g=b(f),j=b(h._templates.item.replace("{{label}}",a.button||a.name)).data(d,a).on("click."+d,function(){var b=g.data(d);b&&(b.disable(f),j.removeClass(c).siblings().removeClass(c),g.data(d,"")),b&&a.name==b.name||(a.enable(f),j.addClass(c),g.data(d,a))});k(j,g);var l=i.get(f.id)||g.attr("data-editor")||i.NONE;a.name.toUpperCase()==l.toUpperCase()&&(a.enable(f),j.addClass(c),g.data(d,a))})}},o=function(a){var c;h=b.extend({},e,a||{});var d=b(h.template),k=d.find(".prefs-selector").remove();h._templates.container=d[0].outerHTML,h._templates.item=k[0].outerHTML,g=b(h.textareas),g.length&&(j.forEach(function(a){if(a.onLoad=n(a),m(a)){if(console.log("installing",a.name),a.css)for(c=0;c<a.css.length;c++)b("head").append('<link rel="stylesheet" href="'+a.css[c]+'" type="text/css">');a.js&&b.getScripts(a.js,a.onLoad)}else a.onLoad()}),h.remember&&(i=new f))},p=function(){g.each(function(a,c){var e=b(c),f=e.data(d);f&&f.disable(c)}),g.off("."+d),b("."+d).remove()};a.infiniteProteus={addEditor:l,init:o,forget:i&&i.clear,destroy:p}}(window,window.jQuery);
/* infiniteproteus - v0.2.0 - 2013-10-02 */
!function(a,b){"use strict";var c="finiteEruptions",d={textareas:"textarea",remember:!0,template:'<div class="btn-group">  <button class="btn btn-mini prefs-selector" type=button>{{label}}</button></div>',activeBtnClass:"btn-primary",getUI:function(a){return a.closest(".control-group").find("."+c)},placeUI:function(a,b){a.prependTo(b.closest(".control-group"))},_templates:{}};b.getScripts=function(a,c){var d=function(a,c){b.when(b.ajax({url:a.shift(),dataType:"script",cache:!0})).then(function(){a.length?d(a,c):c()})};d(a,c)};var e=function(a){this.NONE="none",this.storage=window.localStorage,this.storageKey=c,this.data=void 0,a.keyMaker&&(this.keyMaker=a.keyMaker),this.load()};e.prototype.load=function(){var a={},b=this.storage.getItem(this.storageKey);this.data=b?JSON.parse(b):a},e.prototype.save=function(){this.storage.setItem(this.storageKey,JSON.stringify(this.data))},e.prototype.keyMaker=function(a){return a},e.prototype.attachTo=function(a,d){var e=this,f=d.attr("id");a.on("click."+c,".prefs-selector",function(){var a=b(this),h=a.data(c).name,i=a.hasClass(g.activeBtnClass),j=i?h:e.NONE,k=d.attr("data-editor")||e.NONE;e.data[e.keyMaker(f)]=j.toUpperCase()===k.toUpperCase()?void 0:j,e.save()})},e.prototype.clear=function(){this.storage.removeItem(this.storageKey)},e.prototype.get=function(a){return this.data[this.keyMaker(a)]};var f,g,h,i=[],j=function(a,d){var e=g.getUI(d);e.length||(e=b(g._templates.container).addClass(c),g.placeUI(e,d),g.remember&&h.attachTo(e,d)),a.appendTo(e)},k=function(a){i.push(a)},l=function(a){return a.isInstalled?!a.isInstalled():a.css&&a.css.length?!b("link[href*='"+a.css[0]+"']").length:!0},m=function(a){return function(){a.init&&a.init(),f.each(function(d,e){var f=b(e),i=f.attr("data-editor"),k=b(g._templates.item.replace("{{label}}",a.button||a.name)).data(c,a).on("click."+c,function(){var b=f.data(c);b&&(b.disable(e),k.removeClass(g.activeBtnClass).siblings().removeClass(g.activeBtnClass),f.data(c,"")),b&&a.name==b.name||(a.enable(e),k.addClass(g.activeBtnClass),f.data(c,a))});i&&a.name.toUpperCase()==i.toUpperCase()&&k.addClass(c+"-default"),j(k,f);var l=h.get(e.id)||i||h.NONE;a.name.toUpperCase()==l.toUpperCase()&&(a.enable(e),k.addClass(g.activeBtnClass),f.data(c,a))})}},n=function(a){var c;g=b.extend({},d,a||{});var j=b(g.template),k=j.find(".prefs-selector").remove();if(g._templates.container=j[0].outerHTML,g._templates.item=k[0].outerHTML,f=b(g.textareas),f.length&&(i.forEach(function(a){if(a.onLoad=m(a),l(a)){if(console.log("installing",a.name),a.css)for(c=0;c<a.css.length;c++)b("head").append('<link rel="stylesheet" href="'+a.css[c]+'" type="text/css">');a.js&&b.getScripts(a.js,a.onLoad)}else a.onLoad()}),g.remember)){var n={};"function"==typeof g.remember&&(n.keyMaker=g.remember),h=new e(n)}},o=function(){f.each(function(a,d){var e=b(d),f=e.data(c);f&&f.disable(d)}),f.off("."+c),b("."+c).remove()};a.infiniteProteus={addEditor:k,init:n,forget:h&&h.clear,destroy:o}}(window,window.jQuery);